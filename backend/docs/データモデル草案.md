# データモデル草案 / ER図

> `docs/キックオフ.md` と `backend/app/api/api仕様.md` の要件をもとに作成したデータモデル草案です。
> ハッカソンスコープで実装するエンティティとリレーションを定義しています。

---

## エンティティ一覧

### User（ユーザー）

| カラム | 型 | 備考 |
|--------|----|----|
| id | BIGINT PK | |
| email | VARCHAR(255) UNIQUE | ログインID |
| password_hash | VARCHAR | |
| name | VARCHAR(100) | 表示名 |
| created_at | TIMESTAMP | |
| updated_at | TIMESTAMP | |

---

### UserSettings（個人設定）※ User と 1:1

| カラム | 型 | 備考 |
|--------|----|----|
| id | BIGINT PK | |
| user_id | BIGINT FK → User | UNIQUE |
| home_address | VARCHAR(255) | 経路・天気の基点 |
| home_lat | DECIMAL(9,6) | nullable |
| home_lon | DECIMAL(9,6) | nullable |
| preparation_minutes | INT | 身支度時間（分） |
| timezone | VARCHAR(50) | デフォルト: Asia/Tokyo |
| created_at | TIMESTAMP | |
| updated_at | TIMESTAMP | |

**対応エンドポイント:** `GET/PUT /users/me/settings`

---

### Tag（タグマスタ・グローバル）

| カラム | 型 | 備考 |
|--------|----|----|
| id | BIGINT PK | |
| name | VARCHAR(50) UNIQUE | e.g. "デート", "会食"（全ユーザー共通） |

### ScheduleTag（Schedule と Tag の中間テーブル）

| カラム | 型 | 備考 |
|--------|----|----|
| schedule_id | BIGINT FK → Schedule | |
| tag_id | BIGINT FK → Tag | |
| PRIMARY KEY | (schedule_id, tag_id) | |

### TemplateTag（Template と Tag の中間テーブル）

| カラム | 型 | 備考 |
|--------|----|----|
| template_id | BIGINT FK → Template | |
| tag_id | BIGINT FK → Tag | |
| PRIMARY KEY | (template_id, tag_id) | |

---

### Template（テンプレート）

| カラム | 型 | 備考 |
|--------|----|----|
| id | BIGINT PK | |
| user_id | BIGINT FK → User | |
| name | VARCHAR(100) | テンプレート名 |
| destination_name | VARCHAR(255) | nullable |
| destination_address | VARCHAR(255) | nullable |
| destination_lat | DECIMAL(9,6) | nullable |
| destination_lon | DECIMAL(9,6) | nullable |
| travel_mode | ENUM | walking / cycling / transit / driving |
| memo | TEXT | 準備事項 nullable |
| created_at | TIMESTAMP | |
| updated_at | TIMESTAMP | |

**対応エンドポイント:** `GET/POST /templates`, `GET/PUT/DELETE /templates/{id}`, `POST /templates/{id}/apply`

---

### Schedule（予定）

| カラム | 型 | 備考 |
|--------|----|----|
| id | BIGINT PK | |
| user_id | BIGINT FK → User | |
| title | VARCHAR(255) | |
| start_at | TIMESTAMP | 開始日時 |
| end_at | TIMESTAMP | nullable |
| destination_name | VARCHAR(255) | nullable |
| destination_address | VARCHAR(255) | nullable |
| destination_lat | DECIMAL(9,6) | nullable |
| destination_lon | DECIMAL(9,6) | nullable |
| travel_mode | ENUM | walking / cycling / transit / driving |
| memo | TEXT | 準備事項 nullable |
| created_at | TIMESTAMP | |
| updated_at | TIMESTAMP | |

> **設計メモ:** テンプレ適用時はデータをコピーするのみ（`template_id` は持たない）。
> テンプレートを後から編集しても既存の予定に影響しない構成。

**対応エンドポイント:** `GET/POST /schedules`, `GET/PUT/DELETE /schedules/{id}`

---

### NotificationSettings（通知設定）※ User と 1:1

| カラム | 型 | 備考 |
|--------|----|----|
| id | BIGINT PK | |
| user_id | BIGINT FK → User | UNIQUE |
| weather_enabled | BOOLEAN | 天気通知 ON/OFF |
| weather_notify_time | TIME | 毎朝の通知時刻 e.g. 07:00 |
| reminder_enabled | BOOLEAN | 予定リマインダー ON/OFF |
| reminder_minutes_before | INT | 出発X分前に通知 e.g. 30 |
| created_at | TIMESTAMP | |
| updated_at | TIMESTAMP | |

**対応エンドポイント:** `GET/PUT /notifications/settings`

---

### DeviceToken（FCM/APNsトークン）

| カラム | 型 | 備考 |
|--------|----|----|
| id | BIGINT PK | |
| user_id | BIGINT FK → User | |
| token | VARCHAR(512) UNIQUE | FCM/APNsトークン |
| platform | ENUM | ios / android |
| created_at | TIMESTAMP | |

> 1ユーザーが複数端末を持つケースに対応するため別テーブルで管理。

**対応エンドポイント:** `POST /notifications/tokens`, `DELETE /notifications/tokens/{token}`

---

## ER図

```mermaid
erDiagram
    User {
        bigint id PK
        varchar email UK
        varchar password_hash
        varchar name
        timestamp created_at
        timestamp updated_at
    }

    UserSettings {
        bigint id PK
        bigint user_id FK
        varchar home_address
        decimal home_lat
        decimal home_lon
        int preparation_minutes
        varchar timezone
        timestamp created_at
        timestamp updated_at
    }

    NotificationSettings {
        bigint id PK
        bigint user_id FK
        boolean weather_enabled
        time weather_notify_time
        boolean reminder_enabled
        int reminder_minutes_before
        timestamp created_at
        timestamp updated_at
    }

    DeviceToken {
        bigint id PK
        bigint user_id FK
        varchar token UK
        enum platform
        timestamp created_at
    }

    Tag {
        bigint id PK
        varchar name UK
    }

    Template {
        bigint id PK
        bigint user_id FK
        varchar name
        varchar destination_name
        varchar destination_address
        decimal destination_lat
        decimal destination_lon
        enum travel_mode
        text memo
        timestamp created_at
        timestamp updated_at
    }

    TemplateTag {
        bigint template_id FK
        bigint tag_id FK
    }

    Schedule {
        bigint id PK
        bigint user_id FK
        varchar title
        timestamp start_at
        timestamp end_at
        varchar destination_name
        varchar destination_address
        decimal destination_lat
        decimal destination_lon
        enum travel_mode
        text memo
        timestamp created_at
        timestamp updated_at
    }

    ScheduleTag {
        bigint schedule_id FK
        bigint tag_id FK
    }

    User ||--|| UserSettings : "has"
    User ||--|| NotificationSettings : "has"
    User ||--o{ DeviceToken : "has"
    User ||--o{ Template : "owns"
    User ||--o{ Schedule : "owns"
    Template ||--o{ TemplateTag : ""
    Tag ||--o{ TemplateTag : ""
    Schedule ||--o{ ScheduleTag : ""
    Tag ||--o{ ScheduleTag : ""
```

---

## 確定した設計判断

| 項目 | 判断 | 理由 |
|------|------|------|
| `template_id` を Schedule に持つか | **持たない** | テンプレ適用はコピーのみ。テンプレ編集が既存予定に波及しない |
| タグ管理 | **Tag + 中間テーブル（ScheduleTag / TemplateTag）** | Schedule と Template を独立して多対多管理 |
| DeviceToken | **別テーブル** | 1ユーザー複数端末を想定 |
| UserSettings | **User と別テーブル（1:1）** | プロフィールと設定を分離し、取得・更新を独立して行えるようにする |
| 天気・経路データ | **DBに保存しない** | BFF として外部API（WeatherAPI.com 等）をリクエスト時に都度呼び出す |

---

## 仕様確認が必要な事項

実装前にチームで確認・決定が必要な未決定事項。
各項目に「現在の草案での扱い」「代替案・影響」を記載。

### A. Tag（タグ）関連

| # | 確認事項 | 現在の草案 | 代替案 / 影響 |
|---|---------|-----------|--------------|
| A-1 | **タグのスコープ** — グローバル（全ユーザー共通）か、ユーザーごと個別か | グローバル（`Tag.name UNIQUE`） | per-user: `Tag` に `user_id` FK を追加。同名タグをユーザーごとに持てる |
| A-2 | **タグの作成権限** — ユーザーが自由にタグを作れるか、事前定義のみか | 自由作成と仮定 | 事前定義のみなら初期データ投入（seed）が必要。管理者機能も要検討 |

### B. Schedule / Template 関連

| # | 確認事項 | 現在の草案 | 代替案 / 影響 |
|---|---------|-----------|--------------|
| B-1 | **travel_mode の ENUM 値** — walking / cycling / transit / driving で十分か | 4値 | cycling 不要ならシンプル化。「移動なし（none）」が必要なら追加 |
| B-2 | **Schedule.end_at の nullable** — 終日予定や時刻未定に対応するか | nullable | NOT NULL にするとUI側で必須入力になる |
| B-3 | **Schedule.travel_mode の nullable** — 目的地なし予定（自宅リモート等）に対応するか | nullable 明示なし（未定） | NOT NULL にすると移動手段が必須入力になる |
| B-4 | **終日フラグ（is_all_day）の必要性** — カレンダー機能で終日イベントを扱うか | なし | 追加する場合 Schedule に `is_all_day BOOLEAN` カラムを追加 |
| B-5 | **ソフトデリートの必要性** — 削除時に物理削除か、論理削除（deleted_at）か | 物理削除と仮定 | 論理削除なら `deleted_at TIMESTAMP nullable` を Schedule / Template に追加 |
| B-6 | **繰り返し予定の対応** — 毎週月曜など定期的な予定をサポートするか | 非対応 | 対応するなら `recurrence_rule` カラムまたは別テーブルが必要 |

### C. 通知関連

| # | 確認事項 | 現在の草案 | 代替案 / 影響 |
|---|---------|-----------|--------------|
| C-1 | **リマインダーの複数設定** — 「30分前」と「1時間前」など複数タイミングを設定できるか | `reminder_minutes_before` の INT 1つのみ | 複数対応する場合は `NotificationSettings` を 1:N にするか JSON 型カラムが必要 |
| C-2 | **DeviceToken の有効期限管理** — 期限切れ・無効トークンをどう扱うか | `expired_at` 等のフィールドなし | push 失敗時に削除するだけでよければ追加不要。定期 purge するなら `last_used_at` を追加 |

### D. UserSettings / 初期化フロー関連

| # | 確認事項 | 現在の草案 | 代替案 / 影響 |
|---|---------|-----------|--------------|
| D-1 | **UserSettings / NotificationSettings の初期作成タイミング** — ユーザー登録時に自動作成するか、初回アクセス時に遅延作成するか | 未定 | 登録時に一括作成: シンプルだがデフォルト値の設計が必要。遅延作成: API側で null チェックが必要 |

### E. 認証関連

| # | 確認事項 | 現在の草案 | 代替案 / 影響 |
|---|---------|-----------|--------------|
| E-1 | **認証方式** — JWT か OAuth2 か（api仕様.md § 2 で未決定） | 未決定（JWT推奨と記載） | OAuth2（Google連携）を選ぶ場合は `User` に `google_id` 等が必要 |
| E-2 | **パスワードリセット機能の必要性** — ハッカソンスコープに含めるか | 非対応（データモデルなし） | 対応するなら `PasswordResetToken` テーブルを追加 |
